---
title: "Organize SNAPP Results"
output: html_notebook
---

This script reads in the SNAPP results and prepares covariates for analysis. 

```{r setup}
rm(list = ls())
require( tidyverse)

responses <- read_csv('raw_data/snapp_responses-toAndy.csv') 
user_info <- read_csv('raw_data/snapp_users_noemail.csv')
taxa_info <- read_csv('raw_data/species incl mivs for Andy out.csv')
key_info  <- read_csv('raw_data/snapp_responses_out-corr-only100spp-toErol.csv')

```


## Rename some columns 
```{r}

responses <- 
  responses %>% 
  rename( 'response' = answer )

key_info <- 
  key_info %>%
  rename( 'photo_key' = species, 'photo_region' = global_region )

user_info <- 
  user_info %>% 
  rename( 'user_region' = region ) 

```

## Format user info 

```{r}
user_info <-
  user_info %>% 
  mutate( user_region = str_to_title( str_replace(user_region, '-', ' ' )) ) %>% 
  mutate( user_region = ifelse( user_region == 'Australasia Oceania' , 'Australasia/Oceania', user_region)) # format to match taxa region


```

## Format key info 
```{r}

key_info <- 
  key_info %>%
  distinct( filename, photo_key, photo_region )  

```

## Format taxa info 

```{r}

taxa_info <- 
  taxa_info %>% 
  select(family, genus, binomial, mivs, inCSchallenge ) %>% 
  gather(taxonomic_level, taxa, c(family, genus, binomial)) %>% 
  select( taxa, taxonomic_level, inCSchallenge, mivs ) %>% 
  group_by( taxa, taxonomic_level) %>% 
  mutate(   mivs = ifelse( taxonomic_level != 'binomial' & n_distinct(mivs) > 1, 'ambiguous', mivs), 
            inCSchallenge = ifelse ( any( inCSchallenge == 1), 1, 0)) %>% 
  distinct() 

taxa_info %>% 
  filter( taxonomic_level == 'family') %>% 
  distinct( taxonomic_level, taxa, mivs, inCSchallenge)

taxa_info %>% 
  filter( taxonomic_level == 'genus') %>% 
  distinct(taxonomic_level, taxa, mivs, inCSchallenge ) 

taxa_info %>% 
  filter( taxonomic_level == 'binomial') %>% 
  distinct(taxonomic_level, taxa, mivs, inCSchallenge )  %>% 
  filter( inCSchallenge == 1) 


# get taxa region 



taxa_info %>% 
  left_join( 
    (key_info %>% distinct(photo_key, photo_region)), by = c('taxa' = 'photo_key')
    ) %>% arrange( photo_region) %>% View




```

## organize photo keys 

```{r}

key_info <- 
  key_info %>%
  distinct( filename, species, global_region ) %>% 
  rename( photo_key = species )

key_info %>% arrange( filename) %>% 
  group_by( photo_key ) %>% 
  mutate( n_region = n_distinct(global_region)) %>% 
  filter( n_region > 1 )


```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
